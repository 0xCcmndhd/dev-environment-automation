# Caddyfile Template
{
    local_certs
}

# --- Core infra ---
proxmox.${LOCAL_DOMAIN} {
    reverse_proxy https://${PROXMOX_IP}:8006 {
        transport http { tls_insecure_skip_verify }
    }
}
unifi.${LOCAL_DOMAIN} {
    reverse_proxy https://${UNIFI_IP}:443 {
        transport http { tls_insecure_skip_verify }
    }
}

# --- Authelia portal helper (optional) ---
authelia.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }

# Helper snippet: forward_auth
@authelia_local path /authelia*
(handle) {
    # placeholder for path match; used inline
}
(handle_sso app) {
    # not real Caddy syntax; use explicit blocks below (kept here as a mental template)
}

# --- Utilities (behind SSO unless noted) ---
auth.glance.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
glance.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.glance.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
            header_up X-Forwarded-Proto https
            header_up -Authorization
        }
        reverse_proxy glance:8080 { header_up X-Forwarded-Proto https }
    }
}

auth.code.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
code.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.code.${LOCAL_DOMAIN}{uri} 302
    handle_path /websocket {
        reverse_proxy code:8080 { header_up X-Forwarded-Proto https }
    }
    handle {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
            header_up X-Forwarded-Proto https
            header_up -Authorization
        }
        reverse_proxy code:8080 { header_up X-Forwarded-Proto https }
    }
}

# Vaultwarden: no SSO except /admin protected
auth.vault.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
vault.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.vault.${LOCAL_DOMAIN}{uri} 302
    @admin path /admin*
    route @admin {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Name Remote-Email Remote-Groups
            header_up X-Forwarded-Proto https
            header_up -Authorization
        }
        reverse_proxy vaultwarden:80 { header_up X-Forwarded-Proto https }
    }
    handle {
        reverse_proxy vaultwarden:80 { header_up X-Forwarded-Proto https }
    }
}

auth.uptime.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
uptime.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.uptime.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Name Remote-Email Remote-Groups
            header_up X-Forwarded-Proto https
            header_up -Authorization
        }
        reverse_proxy uptime-kuma:3001 { header_up X-Forwarded-Proto https }
    }
}

# ntfy: consider no SSO or token-based auth. Default: SSO protected.
auth.ntfy.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
ntfy.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.ntfy.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Name Remote-Email Remote-Groups
            header_up X-Forwarded-Proto https
            header_up -Authorization
        }
        reverse_proxy ntfy:80 { header_up X-Forwarded-Proto https }
    }
}

# Kiwix (no SSO by default)
kiwix.${LOCAL_DOMAIN} { reverse_proxy kiwix:8080 }

# CouchDB (Obsidian LiveSync) â€” recommend SSO plus couch auth
auth.livesync.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
livesync.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.livesync.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Name Remote-Email Remote-Groups
            header_up X-Forwarded-Proto https
            header_up -Authorization
        }
        reverse_proxy couchdb:5984 { header_up X-Forwarded-Proto https }
    }
}

speedtest.lan {
    tls internal
    reverse_proxy http://openspeedtest:3000 {
        header_up Host speedtest.lan
    }
}

librespeed.lan {
    tls internal
    reverse_proxy http://librespeed:80 {
        header_up Host librespeed.lan
    }
}
# --- AI (unchanged; proxy to AI host by IP) ---
open.${LOCAL_DOMAIN}     { reverse_proxy http://${AI_SERVER_IP}:3000 }
silly.${LOCAL_DOMAIN}    { reverse_proxy http://${AI_SERVER_IP}:3001 }
auth.n8n.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
n8n.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.n8n.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Name Remote-Email Remote-Groups
            header_up X-Forwarded-Proto https
            header_up -Authorization
        }
        reverse_proxy http://${AI_SERVER_IP}:5678 { header_up X-Forwarded-Proto https }
    }
}
auth.comfy.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
comfy.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.comfy.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Name Remote-Email Remote-Groups
            header_up X-Forwarded-Proto https
            header_up -Authorization
        }
        reverse_proxy http://${AI_SERVER_IP}:8188 { header_up X-Forwarded-Proto https }
    }
}
ollama.${LOCAL_DOMAIN} { reverse_proxy http://${AI_SERVER_IP}:11434 }
tts.${LOCAL_DOMAIN}    { reverse_proxy http://${AI_SERVER_IP}:8010 }
auth.ooba.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
ooba.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.ooba.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Name Remote-Email Remote-Groups
            header_up X-Forwarded-Proto https
            header_up -Authorization
        }
        reverse_proxy ${AI_SERVER_IP}:7860 {
            header_up X-Forwarded-Proto https
            header_up Host {host}
        }
    }
}
ooba-api.${LOCAL_DOMAIN} {
    reverse_proxy ${AI_SERVER_IP}:5000 { header_up X-Forwarded-Proto https }
}

# --- Media (proxy to MEDIA_SERVER_IP) ---
# Arr suite
auth.sonarr.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
sonarr.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.sonarr.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${MEDIA_SERVER_IP}:8989 { header_up X-Forwarded-Proto https }
    }
}
auth.radarr.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
radarr.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.radarr.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${MEDIA_SERVER_IP}:7878 { header_up X-Forwarded-Proto https }
    }
}
auth.prowlarr.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
prowlarr.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.prowlarr.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${MEDIA_SERVER_IP}:9696 { header_up X-Forwarded-Proto https }
    }
}
auth.lidarr.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
lidarr.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.lidarr.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${MEDIA_SERVER_IP}:8686 { header_up X-Forwarded-Proto https }
    }
}
auth.readarr.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
readarr.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.readarr.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${MEDIA_SERVER_IP}:8787 { header_up X-Forwarded-Proto https }
    }
}
auth.bazarr.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
bazarr.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.bazarr.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${MEDIA_SERVER_IP}:6767 { header_up X-Forwarded-Proto https }
    }
}

# Media servers
jellyfin.${LOCAL_DOMAIN} {
    # Protect if desired
    reverse_proxy http://${MEDIA_SERVER_IP}:8096
}
plex.${LOCAL_DOMAIN} {
    reverse_proxy http://${MEDIA_SERVER_IP}:32400
}

auth.overseerr.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
overseerr.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.overseerr.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${MEDIA_SERVER_IP}:5055 { header_up X-Forwarded-Proto https }
    }
}

auth.calibre-web.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
calibre-web.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.calibre-web.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${MEDIA_SERVER_IP}:8083 { header_up X-Forwarded-Proto https }
    }
}
audiobookshelf.${LOCAL_DOMAIN} {
    reverse_proxy http://${MEDIA_SERVER_IP}:13378
}

auth.photoprism.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
photoprism.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.photoprism.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${MEDIA_SERVER_IP}:2342 { header_up X-Forwarded-Proto https }
    }
}

auth.immich.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
immich.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.immich.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${MEDIA_SERVER_IP}:2283 { header_up X-Forwarded-Proto https }
    }
}

# --- Downloads (proxy to DOWNLOADS_SERVER_IP) ---
auth.qbittorrent.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
qbittorrent.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.qbittorrent.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${DOWNLOADS_SERVER_IP}:8080 { header_up X-Forwarded-Proto https }
    }
}
auth.sab.${LOCAL_DOMAIN} { reverse_proxy authelia:9091 }
sab.${LOCAL_DOMAIN} {
    @local path /authelia*
    redir @local https://auth.sab.${LOCAL_DOMAIN}{uri} 302
    handle {
        forward_auth authelia:9091 { uri /api/authz/forward-auth copy_headers Remote-User Remote-Name Remote-Email Remote-Groups header_up X-Forwarded-Proto https header_up -Authorization }
        reverse_proxy http://${DOWNLOADS_SERVER_IP}:8070 { header_up X-Forwarded-Proto https }
    }
}
yt.${LOCAL_DOMAIN} { reverse_proxy http://${DOWNLOADS_SERVER_IP}:8484 }
pinchflat.${LOCAL_DOMAIN} { reverse_proxy http://${DOWNLOADS_SERVER_IP}:8945 }
podgrab.${LOCAL_DOMAIN}   { reverse_proxy http://${DOWNLOADS_SERVER_IP}:8088 }
